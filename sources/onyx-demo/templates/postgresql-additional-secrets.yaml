{{- if and .Values.postgresql.enabled .Values.postgresql.initdb.enabled }}
{{- range .Values.postgresql.initdb.databases }}
{{- if .createSecret }}
{{- $lowerDBName := lower .name }}
{{- $safeDBName := regexReplaceAll "[^a-z0-9-]+" "-" $lowerDBName }}
{{- $sanitizedDBName := trimAll "-" $safeDBName }}
{{- $effectiveDBName := ternary $sanitizedDBName "db" (ne $sanitizedDBName "") }}
{{- $secretName := printf "%s-%s-credentials" $.Release.Name $effectiveDBName | lower | trunc 63 | trimSuffix "-" }}
{{- $encodedPassword := .password | replace "%" "%25" | replace "!" "%21" | replace "@" "%40" | replace "#" "%23" | replace "$" "%24" | replace "^" "%5E" | replace "&" "%26" | replace "*" "%2A" }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ $.Release.Namespace }}
  labels:
    app: postgresql
    database: {{ .name }}
    {{- include "onyx.labels" $ | nindent 4 }}
type: Opaque
stringData:
  POSTGRES_USER: {{ .user | quote }}
  POSTGRES_PASSWORD: {{ .password | quote }}
  POSTGRES_DB: {{ .name | quote }}
  POSTGRES_HOST: {{ include "onyx.fullname" $ }}-postgresql
  POSTGRES_PORT: "5432"
  DATABASE_URL: "postgresql://{{ .user }}:{{ $encodedPassword }}@{{ include "onyx.fullname" $ }}-postgresql:5432/{{ .name }}"
  SQLALCHEMY_DATABASE_URI: "postgresql://{{ .user }}:{{ $encodedPassword }}@{{ include "onyx.fullname" $ }}-postgresql:5432/{{ .name }}"
{{- end }}
{{- end }}
{{- end }}
