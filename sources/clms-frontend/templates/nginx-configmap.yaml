apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "appl.fullname" . }}-nginx-config
  labels:
    {{- include "appl.labels" . | nindent 4 }}
data:
  upstream.conf: |
    upstream varnish_backend {
        server {{ .Values.varnish.serviceName }}:{{ .Values.varnish.port }};
    }

  default.conf: |
    server {
        listen       80;
        server_name  {{ .Values.volto.hostname }};

        # Security headers
        add_header Server "HTTPS" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Referrer-Policy "origin" always;
        add_header Content-Security-Policy "default-src https: data: 'unsafe-inline' 'unsafe-eval'; connect-src https: data:; frame-src http: data:; upgrade-insecure-requests" always;

        # Real IP configuration
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;

        # Logging
        access_log /dev/stdout;
        error_log /dev/stderr;

        # Block dangerous HTTP methods
        if ($request_method ~ ^(PUT|DELETE|PROPFIND|OPTIONS|TRACE|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK)$) {
            return 403;
        }

        # Redirect old hostnames to primary hostname
        if ($host = "copernicus.eea.europa.eu") {
            return 301 https://{{ .Values.volto.hostname }}$request_uri;
        }
        if ($host = "kite.eea.europa.eu") {
            return 301 https://{{ .Values.volto.hostname }}$request_uri;
        }

        # Redirect /global to /global/ (with trailing slash)
        location = /global {
            return 301 https://{{ .Values.volto.hostname }}/global/;
        }

        # Proxy to VITO CGLS for /global/*
        location /global/ {
            proxy_ssl_server_name on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;

            # Rewrite /global/* to /* for upstream
            rewrite ^/global(/.*)?$ $1 break;

            proxy_pass https://cgls.vito.be;
            proxy_set_header Host cgls.vito.be;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Cookie domain rewriting (equivalent to ProxyPassReverseCookieDomain)
            proxy_cookie_domain cgls.vito.be {{ .Values.volto.hostname }};
            proxy_cookie_domain .cgls.vito.be .{{ .Values.volto.hostname }};

            # URL rewriting in HTML content (equivalent to ProxyHTMLURLMap)
            sub_filter 'https://cgls.vito.be' '/global';
            sub_filter 'http://cgls.vito.be' '/global';
            sub_filter 'href="/' 'href="/global/';
            sub_filter 'src="/' 'src="/global/';
            sub_filter_once off;
            sub_filter_types text/html text/css text/javascript application/javascript;

            # Proxy redirects
            proxy_redirect https://cgls.vito.be/ /global/;
            proxy_redirect http://cgls.vito.be/ /global/;

            # Timeout settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 120s;

            # Buffering for sub_filter
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
        }

        # Redirect /content to /content/ (with trailing slash)
        location = /content {
            return 301 https://{{ .Values.volto.hostname }}/content/;
        }

        # Serve static content from /content/*
        location /content/ {
            alias /staticcontent/;
            autoindex off;
            expires 1d;
            add_header Cache-Control "public, immutable";

            # Disable indexing
            location ~ /\. {
                deny all;
            }
        }

        # Proxy everything else to Varnish
        location / {
            proxy_pass http://varnish_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_redirect off;

            # Timeout settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 120s;
            proxy_read_timeout 480s;

            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # Gzip compression (equivalent to SetOutputFilter DEFLATE)
        gzip on;
        gzip_vary on;
        gzip_types text/html text/plain text/xml text/css text/javascript application/x-javascript application/javascript application/json;
        gzip_disable "msie6";

        # Don't compress already compressed files
        gzip_proxied any;
        gzip_comp_level 6;
    }
