{{- if and .Values.postgresql.enabled .Values.postgresql.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "onyx.fullname" . }}-postgresql-backup
  namespace: {{ .Release.Namespace }}
  labels:
    app: postgresql-backup
    {{- include "onyx.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.postgresql.backup.schedule | quote }}
  successfulJobsHistoryLimit: {{ .Values.postgresql.backup.successfulJobsHistoryLimit | default 3 }}
  failedJobsHistoryLimit: {{ .Values.postgresql.backup.failedJobsHistoryLimit | default 3 }}
  jobTemplate:
    spec:
      # Keep completed Job pods for 24 hours to allow log inspection
      # After 24 hours, Kubernetes automatically deletes the Job and its pods
      ttlSecondsAfterFinished: {{ .Values.postgresql.backup.ttlSecondsAfterFinished | default 86400 }}
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: postgresql-backup
              image: postgres:{{ .Values.postgresql.simple.tag | default "16" }}
              args:
                - /bin/bash
                - -c
                - |
                  set -euo pipefail
                  {{- if .Values.postgresql.backup.retention.enabled }}
                  RETENTION_DAYS={{ .Values.postgresql.backup.retention.days | default 7 }}
                  {{- end }}
                  {{- if .Values.postgresql.restore.database }}
                  TARGET_DB="{{ .Values.postgresql.restore.database }}"
                  {{- else }}
                  TARGET_DB="onyx"
                  {{- end }}
                  {{- if .Values.postgresql.initdb.enabled }}
                  DATABASES=$(PGPASSWORD="$POSTGRES_PASSWORD" psql -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname NOT IN ('postgres', 'template0', 'template1');")
                  {{- else }}
                  DATABASES="$TARGET_DB"
                  {{- end }}
                  mkdir -p /backups
                  TS=$(date +%Y%m%d_%H%M%S)
                  for DB in $DATABASES; do
                    echo "Backing up database: $DB"
                    BACKUP_FILE_UNCOMPRESSED="/backups/${DB}_${TS}.sql"
                    BACKUP_FILE="/backups/${DB}_${TS}.sql.gz"

                    echo "Step 1: Creating backup (uncompressed)..."
                    PGPASSWORD="$POSTGRES_PASSWORD" pg_dump -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d "$DB" \
                      --format=custom --blobs --encoding=UTF8 --no-owner --no-privileges -f "$BACKUP_FILE_UNCOMPRESSED"

                    echo "Step 2: Compressing backup..."
                    gzip "$BACKUP_FILE_UNCOMPRESSED"

                    echo "Backup for $DB completed: $BACKUP_FILE"
                    ls -lh "$BACKUP_FILE"
                  done
                  {{- if .Values.postgresql.backup.retention.enabled }}
                  echo "Cleaning up backups older than $RETENTION_DAYS days..."
                  find /backups -type f -name \"*.sql.gz\" -mtime +${RETENTION_DAYS} -print -delete
                  {{- end }}
              env:
                - name: POSTGRES_HOST
                  value: {{ include "onyx.fullname" . }}-postgresql
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.auth.postgresql.secretName }}
                      key: {{ .Values.auth.postgresql.secretKeys.POSTGRES_USER }}
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.auth.postgresql.secretName }}
                      key: {{ .Values.auth.postgresql.secretKeys.POSTGRES_PASSWORD }}
              volumeMounts:
                - name: postgresql-backup
                  mountPath: /backups
              {{- toYaml .Values.postgresql.backup.resources | nindent 14 }}
          volumes:
            - name: postgresql-backup
              persistentVolumeClaim:
                claimName: {{ include "onyx.fullname" . }}-postgresql-backup
{{- end }}
