---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-ldapsync
spec:
  schedule: "{{ .Values.matomocronLdapSync.cronSchedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: {{ .Values.jobs.ttlSecondsAfterFinished }}
      template:
        metadata:
          labels:
            app.kubernetes.io/name: "{{ .Release.Name }}-ldapsync"
        spec:
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            fsGroup: 0
          initContainers:
          - name: wait-for-mariadb
            image: busybox
            command: 
              - sh
              - -c
              - >
                until nc -z mariadb 3306;
                do echo waiting for mariadb; sleep 2; done;
          containers:
            - name: matomocron-ldapsync
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              env:
                - name: MATOMO_DATABASE_HOST
                  value: mariadb
                - name: MATOMO_DATABASE_PORT_NUMBER
                  value: "3306"
                - name: MATOMO_DATABASE_USER
                  value: {{ .Values.mariadb.environment.MARIADB_USER | quote }}
                - name: MATOMO_DATABASE_NAME
                  value: {{ .Values.mariadb.environment.MARIADB_DATABASE | quote }}
                - name: MATOMO_DATABASE_PASSWORD
                  value: {{ .Values.mariadb.environment.MARIADB_PASSWORD | quote }}
                - name: ALLOW_EMPTY_PASSWORD
                  value: "no"
                - name: TZ
                  value: "{{ .Values.timezone }}"
                - name: AZURE_TENANT_ID
                  value: {{ .Values.matomocronLdapSync.environment.AZURE_TENANT_ID | quote }}
                - name: AZURE_CLIENT_ID
                  value: {{ .Values.matomocronLdapSync.environment.AZURE_CLIENT_ID | quote }}
                - name: AZURE_VIEW_GROUP
                  value: {{ .Values.matomocronLdapSync.environment.AZURE_VIEW_GROUP | quote }}
                - name: AZURE_CLIENT_SECRET
                  value: {{ .Values.matomocronLdapSync.environment.AZURE_CLIENT_SECRET | quote }}
                - name: ADMIN_EMAIL
                  value: {{ .Values.matomocronLdapSync.environment.ADMIN_EMAIL | quote }}
              command:
                - bash
                - -c
              args:
                - /usr/bin/run_ldapsync.sh || true
              resources:
                requests:
                  memory: "{{ .Values.matomocronLdapSync.resources.requests.memory }}"
                limits:
                  memory: "{{ .Values.matomocronLdapSync.resources.limits.memory }}"
              volumeMounts:
                - name: matomo-pv
                  mountPath: /bitnami
          restartPolicy: Never
          volumes:
            - name: matomo-pv
              persistentVolumeClaim:
                claimName: {{ .Release.Name }}-matomo-pvc
