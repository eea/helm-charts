{{- $labels := ( include "appl.labels" . ) -}}
{{- $values := .Values -}}
{{- $appversion := .Chart.AppVersion }}
{{- $release := .Release.Name }}
{{- range $index, $archiver := .Values.matomocronArchive }}

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $release }}-archive-{{ $index }}
spec:
  schedule: "{{ $archiver.cronSchedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: {{ $values.jobs.ttlSecondsAfterFinished }}
      template:
        metadata:
          labels:
            app.kubernetes.io/name: {{ $release }}-archive
        spec:
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            fsGroup: 0
          initContainers:
          - name: wait-for-mariadb
            image: busybox
            command: 
              - sh
              - -c
              - >
                until nc -z mariadb 3306;
                do echo waiting for mariadb; sleep 2; done;
          containers:
            - name: matomocron-archive-{{ $index }}
              image: "{{ $values.image.repository }}:{{ $values.image.tag | default $appversion }}"
              env:
                - name: MATOMO_DATABASE_HOST
                  value: mariadb
                - name: MATOMO_DATABASE_PORT_NUMBER
                  value: "3306"
                - name: MATOMO_DATABASE_USER
                  value: {{ $values.mariadb.environment.MARIADB_USER | quote }}
                - name: MATOMO_DATABASE_NAME
                  value: {{ $values.mariadb.environment.MARIADB_DATABASE | quote }}
                - name: MATOMO_DATABASE_PASSWORD
                  value: {{ $values.mariadb.environment.MARIADB_PASSWORD | quote }}
                - name: ALLOW_EMPTY_PASSWORD
                  value: "no"
                - name: TZ
                  value: "{{ $values.timezone }}"
                - name: MATOMO_URL
                  value: "matomo:{{ $values.matomo.environment.APACHE_HTTP_PORT_NUMBER }}"

                {{- range $key, $value := $archiver.environment }}
                {{- if ($value) }}
                - name: {{ $key }}
                  value: {{ $value | quote }}
                {{- end }}
                {{- end }}

              command:
                - bash
                - -c
              args:
                - . /opt/bitnami/scripts/matomo-env.sh &&
                  . /opt/bitnami/scripts/libbitnami.sh &&
                  . /opt/bitnami/scripts/liblog.sh &&
                  /opt/bitnami/scripts/apache/setup.sh &&
                  /opt/bitnami/scripts/php/setup.sh &&
                  /opt/bitnami/scripts/mysql-client/setup.sh &&
                  /opt/bitnami/scripts/matomo/setup.sh &&
                  /use_matomo_in_rancher.sh &&
                  /post-init.sh &&
                  /usr/bin/run_archiving.sh
              resources:
                requests:
                  memory: "{{ $archiver.resources.requests.memory }}"
                limits:
                  memory: "{{ $archiver.resources.limits.memory }}"
              volumeMounts:
                - name: matomo-pv
                  mountPath: /bitnami
                - name: matomo-tmp
                  mountPath: /bitnami/matomo/tmp
          restartPolicy: Never
          volumes:
            - name: matomo-pv
              persistentVolumeClaim:
                claimName: {{ $release }}-matomo-pvc
            - name: matomo-tmp
              persistentVolumeClaim:
                claimName: {{ $release }}-archive-tmp-pvc

{{- end }}

