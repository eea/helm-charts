apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "traefik.fullname" . }}-dynamic
  labels:
    {{- include "traefik.labels" . | nindent 4 }}
data:
  routes.yaml: |
    http:
{{- /* Parse the string block into a native Helm list */ -}}
{{- $routes := .Values.routes }}
{{- if kindIs "string" $routes }}
{{- $routes = fromYamlArray $routes }}
{{- end }}

      routers:
{{- range $routes }}
        {{ .name }}:
          rule: "{{ .match }}"
          service: {{ .name }}-svc
  {{- if .stripPrefix }}
          middlewares:
            - {{ .name }}-strip
  {{- end }}
{{- end }}

{{- /* Check if ANY route requires a stripPrefix middleware */ -}}
{{- $hasStrip := false }}
{{- range $routes }}{{ if .stripPrefix }}{{ $hasStrip = true }}{{ end }}{{ end }}

{{- if $hasStrip }}
      middlewares:
{{- range $routes }}
  {{- if .stripPrefix }}
        {{ .name }}-strip:
          stripPrefix:
            prefixes:
              - "{{ .stripPrefix }}"
  {{- end }}
{{- end }}
{{- end }}

      services:
{{- range $routes }}
        {{ .name }}-svc:
          loadBalancer:
            servers:
              - url: "http://{{ .service }}.{{ $.Release.Namespace }}.svc.cluster.local:{{ .port }}"
{{- end }}