apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Release.Name }}-data
  labels:
    {{- include "appl.labels" . | nindent 4 }}
    component: data

spec:
  replicas: {{ .Values.initialDataNodes }}
  serviceName: {{ .Release.Name }}-data
  selector:
    matchLabels:
      {{- include "appl.selectorLabels" . | nindent 6 }}
      component: data

  template:
    metadata:
      labels:
        {{- include "appl.selectorLabels" . | nindent 8 }}
        component: data

    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "appl.serviceAccountName" . }}
      
      {{- if .Values.esmaster.password }}
      initContainers:
      - name: config-init
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        command: ['sh', '-c']
        args:
          - |
            echo "Initializing Elasticsearch configuration for data node..."
            # Copy config files from ConfigMap to shared volume
            cp /tmp/config/* /usr/share/elasticsearch/config/
            
            # Generate certificates if they don't exist
            if [ ! -f /usr/share/elasticsearch/config/elastic-certificates.p12 ]; then
              echo "Generating SSL certificates..."
              cd /usr/share/elasticsearch
              echo "Generating PKCS12 certificates..."
              bin/elasticsearch-certutil cert --silent --out config/elastic-certificates.p12 \
                --dns {{ .Release.Name }}-master,{{ .Release.Name }}-data,localhost \
                --ip 127.0.0.1,::1 --pass "" || echo "Certificate generation failed, but continuing..."
            fi
            
            # Set proper permissions
            chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/config/
            echo "Configuration initialization completed"
        volumeMounts:
        - mountPath: /usr/share/elasticsearch/config
          name: elasticconfig
        - mountPath: /tmp/config
          name: elasticsearch-config
        securityContext:
          runAsUser: 0
      {{- end }}
      
      containers:
      - name: {{ .Release.Name }}-data
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        env:
        - name: cluster.name
          value: "{{ .Values.clusterName }}"
        - name: node.name
          value: "${HOSTNAME}"
        - name: cluster.initial_master_nodes
          value: "{{ .Release.Name }}-master"
        - name: discovery.seed_hosts
          value: "{{ .Release.Name }}-master,{{ .Release.Name }}-data"
        - name: bootstrap.memory_lock
          value: "{{ .Values.bootstrapMemoryLock }}"
        - name: node.roles
          value: "data"
        {{- if .Values.useMonitoring }}
        - name: xpack.monitoring.collection.enabled
          value: "true"
        {{- end }}
        {{- if .Values.esmaster.password }}
        - name: xpack.security.enabled
          value: "true"
        - name: xpack.security.transport.ssl.enabled
          value: "true"
        - name: xpack.security.transport.ssl.verification_mode
          value: "certificate"
        - name: xpack.security.transport.ssl.keystore.path
          value: "elastic-certificates.p12"
        - name: xpack.security.transport.ssl.truststore.path
          value: "elastic-certificates.p12"
        - name: elastic_password
          value: "{{ .Values.esmaster.password }}"
        - name: kibana_system_password
          value: "{{ .Values.kibana.password }}"
        - name: DO_NOT_CREATE_USERS
          value: "yes"
        {{- else }}
        - name: xpack.security.enabled
          value: "false"
        - name: xpack.security.transport.ssl.enabled
          value: "false"
        {{- end }}
        {{- if .Values.esmaster.backup.enabled }}
        - name: path.repo
          value: "/backup"
        {{- end }}
        - name: TZ
          value: "{{ .Values.timezone }}"
        - name: ES_JAVA_OPTS
          value: "-Xms{{ .Values.dataHeapSize }} -Xmx{{ .Values.dataHeapSize }}"
        - name: cluster.routing.allocation.disk.watermark.high
          value: "95%"
        - name: cluster.routing.allocation.disk.watermark.low
          value: "93%"

        ports:
        - containerPort: 9200
        - containerPort: 9300

        resources:
          requests:
            memory: {{ .Values.dataMemReservation }}
          limits:
            memory: {{ .Values.dataMemLimit }}
            # Equivalent to ulimits nofile 65536
            ephemeral-storage: 1Gi

        securityContext:
          {{- if .Values.bootstrapMemoryLock }}
          capabilities:
            add:
            - IPC_LOCK
          {{- end }}

        volumeMounts:
        - mountPath: /usr/share/elasticsearch/data
          name: esworkdata
        {{- if .Values.esmaster.backup.enabled }}
        - mountPath: /backup
          name: esbackup
        {{- end }}
        {{- if .Values.esmaster.password }}
        - mountPath: /usr/share/elasticsearch/config
          name: elasticconfig
        {{- end }}

      volumes:
      {{- if not .Values.esworker.persistence.enabled }}
      - name: esworkdata
        emptyDir:
          sizeLimit: 1Gi
      {{- end }}
      {{- if .Values.esmaster.backup.enabled }}
      - name: esbackup
        persistentVolumeClaim:
          claimName: {{ .Values.backupVolumeName }}
      {{- end }}
      {{- if .Values.esmaster.password }}
      - name: elasticconfig
        persistentVolumeClaim:
          claimName: elasticconfig
      - name: elasticsearch-config
        configMap:
          name: {{ .Release.Name }}-elasticsearch-config
      {{- end }}
  {{- if .Values.esworker.persistence.enabled }}
  volumeClaimTemplates:
  - metadata:
      name: esworkdata
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: {{ .Values.esworker.persistence.size }}
  {{- end }}
