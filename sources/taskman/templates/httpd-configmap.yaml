apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-nginx-config-cm

data:
  nginx.conf: |-
    worker_processes auto;

    events {
        worker_connections 1024;
        multi_accept on;
        use epoll;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        sendfile on;
        aio threads;                  # async disk I/O (faster static serve)
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        keepalive_requests 1000;      # reuse upstream connections efficiently
        client_max_body_size 100M;

        # GZIP compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_min_length 512;
        gzip_types text/plain text/css text/javascript application/javascript application/json application/xml image/svg+xml;
        gzip_disable "msie6";

        # Connection reuse
        lingering_close always;

        # Real IP handling (Docker/K8s)
        set_real_ip_from 172.17.0.0/16;
        set_real_ip_from 10.0.0.0/8;
        set_real_ip_from 172.16.0.0/12;
        set_real_ip_from 192.168.0.0/16;
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;

        # --- Logging ---
        # Access log with total + upstream timings (seconds)
        log_format graylog_strict_timed
            '$remote_addr - $remote_user [$time_local] '
            '"$request" $status $body_bytes_sent '
            '"$http_referer" "$http_user_agent" '
            '$request_time $upstream_response_time';
        access_log /var/log/nginx/access.log graylog_strict_timed;

        # --- Upstream (persistent keepalive) ---
        upstream redmine {
            server redmine:3000 max_fails=3 fail_timeout=30s;
            keepalive 128;
        }

        # --- Proxy Cache (RAM metadata + disk data) ---
        proxy_cache_path /var/cache/nginx/redmine_static levels=1:2
            keys_zone=redmine_static:256m   # store ~2M cached entries metadata in RAM
            max_size=10g                    # total disk cache size
            inactive=60d
            use_temp_path=off;

        proxy_temp_path /tmp/nginx-cache-temp;
        proxy_cache_lock_timeout 5s;
        proxy_cache_min_uses 2;

        # File descriptor caching
        open_file_cache max=50000 inactive=60s;
        open_file_cache_valid 120s;
        open_file_cache_min_uses 2;
        open_file_cache_errors on;

        # ================================================================
        # MAIN SERVER
        # ================================================================
        server {
            listen 80 reuseport;          # SO_REUSEPORT for multi-core scaling
            listen [::]:80 reuseport;
            http2 on;
            server_name redmine.example.com;

            # --- Error pages ---
            error_page 404 /errors/404.html;
            error_page 500 501 504 505 /errors/50x.html;
            error_page 502 503 /errors/maintenance.html;

            location /errors/ {
                root /usr/share/nginx/html;
                try_files $uri $uri/ =404;
            }

            # --- Security headers ---
            add_header X-Frame-Options SAMEORIGIN always;
            add_header X-Content-Type-Options nosniff always;
            add_header Referrer-Policy strict-origin-when-cross-origin always;
            add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

            # --- Proxy settings ---
            proxy_read_timeout 600;
            proxy_connect_timeout 30;
            proxy_send_timeout 600;
            proxy_http_version 1.1;
            proxy_request_buffering off;  # stream uploads
            proxy_buffer_size 32k;
            proxy_buffers 64 32k;
            proxy_busy_buffers_size 128k;
            proxy_temp_file_write_size 256k;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # ===========================================================
            # LOCAL STATIC FILES & AUTH-BASED SEARCH BLOCK
            # ===========================================================
            location ~* ^/search {
                if ($cookie__redmine_eea !~* "^1.*$") {
                    return 302 /;
                }
                proxy_pass http://redmine;
            }

            location = /google1c3b89acd75baccf.html { root /usr/share/nginx/html; }
            location = /robots.txt { root /usr/share/nginx/html; }

            # ===========================================================
            # STATIC CACHE (plugin_assets, themes, js, css, images, fonts)
            # ===========================================================
            location ~* ^/(?:plugin_assets|themes|javascripts|stylesheets|images|favicon).*?\.(?:css|js|png|jpg|jpeg|gif|ico|svg|woff2?|ttf)(\?[0-9]+)?$ {
                expires 365d;
                add_header Cache-Control "public, max-age=31536000, immutable";
                access_log off;

                proxy_pass http://redmine;
                proxy_set_header Host $host;

                proxy_cache redmine_static;
                proxy_cache_valid 200 301 302 365d;
                proxy_cache_use_stale error timeout updating;
                proxy_cache_lock on;
                proxy_ignore_headers Cache-Control Set-Cookie;
            }

            # ===========================================================
            # DYNAMIC PAGES (default backend)
            # ===========================================================
            location / {
                proxy_pass http://redmine;
                proxy_intercept_errors on;
                proxy_cache redmine_static;
                proxy_cache_valid 200 10m;
                proxy_cache_bypass $cookie__redmine_session;
                add_header X-Cache-Status $upstream_cache_status always;
            }
        }
    }%   