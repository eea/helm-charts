{{- if .Values.varnish.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "marine-zeo.fullname" . }}-varnish
  labels:
    {{- include "marine-zeo.labels" . | nindent 4 }}
    component: varnish
spec:
  replicas: {{ .Values.varnish.replicaCount }}
  selector:
    matchLabels:
      {{- include "marine-zeo.selectorLabels" . | nindent 6 }}
      component: varnish
  template:
    metadata:
      labels:
        {{- include "marine-zeo.selectorLabels" . | nindent 8 }}
        component: varnish
    spec:
      containers:
      - name: varnish
        image: "{{ .Values.varnish.image.repository }}:{{ .Values.varnish.image.tag }}"
        imagePullPolicy: {{ .Values.varnish.image.pullPolicy }}
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        env:
        - name: TZ
          value: {{ .Values.timezone }}
        - name: AUTOKILL_CRON
          value: "{{ .Values.varnish.environment.AUTOKILL_CRON }}"
        - name: VARNISH_BACKEND
          value: "{{ include "marine-zeo.fullname" . }}-haproxy"
        - name: VARNISH_BACKEND_PORT
          value: "{{ .Values.varnish.environment.VARNISH_BACKEND_PORT }}"
        - name: VARNISH_HTTP_PORT
          value: "{{ .Values.varnish.environment.VARNISH_HTTP_PORT }}"
        - name: VARNISH_SIZE
          value: "{{ .Values.varnish.environment.VARNISH_SIZE }}"
        - name: VARNISH_DNS_TTL
          value: "{{ .Values.varnish.environment.VARNISH_DNS_TTL }}"
        - name: VARNISH_BERESP_TTL
          value: "{{ .Values.varnish.environment.VARNISH_BERESP_TTL }}"
        - name: VARNISH_BERESP_GRACE
          value: "{{ .Values.varnish.environment.VARNISH_BERESP_GRACE }}"
        - name: VARNISH_BERESP_KEEP
          value: "{{ .Values.varnish.environment.VARNISH_BERESP_KEEP }}"
        - name: VARNISH_GZIP_ENABLED
          value: "{{ .Values.varnish.environment.VARNISH_GZIP_ENABLED }}"
        - name: VARNISH_GZIP_JSON_ENABLED
          value: "{{ .Values.varnish.environment.VARNISH_GZIP_JSON_ENABLED }}"
        resources:
          {{- toYaml .Values.varnish.resources | nindent 10 }}
        livenessProbe:
          httpGet:
            path: /ok
            port: http
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 5
        readinessProbe:
          httpGet:
            path: /ok
            port: http
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 3
{{- end }}